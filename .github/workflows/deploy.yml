name: Deploy to Fly.io

on:
  push:
    branches:
      - main

env:
  FLY_APP: news-brief-generator
  IMAGE:   registry.fly.io/news-brief-generator

jobs:

  # Single job: build → push to Fly's private registry → deploy
  # Using registry.fly.io avoids any external registry auth — Fly pulls
  # from its own registry natively with the FLY_API_TOKEN.

  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write .htpasswd from secret
        # HTPASSWD_CONTENT is a GitHub secret containing the raw .htpasswd contents.
        # nginx/.htpasswd is gitignored, so we recreate it here before docker build.
        run: echo "${{ secrets.HTPASSWD_CONTENT }}" > nginx/.htpasswd

      - name: Set up flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Authenticate Docker with Fly registry
        # flyctl auth docker configures Docker credentials for registry.fly.io
        # using the FLY_API_TOKEN env var — no interactive login needed.
        run: flyctl auth docker

      - name: Build and push image to Fly registry
        run: |
          docker build -t ${{ env.IMAGE }}:${{ github.sha }} .
          docker push ${{ env.IMAGE }}:${{ github.sha }}

      - name: Stage secrets and deploy
        # --stage applies secrets atomically with the deploy (no double restart)
        run: |
          flyctl secrets set \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            NEWSAPI_KEY="${{ secrets.NEWSAPI_KEY }}" \
            OPENWEATHERMAP_API_KEY="${{ secrets.OPENWEATHERMAP_API_KEY }}" \
            EXCHANGE_RATE_API_KEY="${{ secrets.EXCHANGE_RATE_API_KEY }}" \
            PEXELS_API_KEY="${{ secrets.PEXELS_API_KEY }}" \
            --app ${{ env.FLY_APP }} \
            --stage
          flyctl deploy \
            --app ${{ env.FLY_APP }} \
            --image ${{ env.IMAGE }}:${{ github.sha }} \
            --wait-timeout 180 \
            --strategy rolling
