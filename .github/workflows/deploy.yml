name: Deploy to Fly.io

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE:    ghcr.io/${{ github.repository }}
  FLY_APP:  news-brief-generator

jobs:

  # ── Stage 1: Build and push Docker image to GitHub Container Registry ───────

  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write .htpasswd from secret
        # HTPASSWD_CONTENT is a GitHub secret containing the raw .htpasswd contents.
        # nginx/.htpasswd is gitignored, so we recreate it here before docker build.
        run: echo "${{ secrets.HTPASSWD_CONTENT }}" > nginx/.htpasswd

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ github.sha }}
            ${{ env.IMAGE }}:latest

  # ── Stage 2: Deploy to Fly.io ─────────────────────────────────────────────

  deploy:
    needs: build
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    steps:
      - name: Set up flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Stage secrets
        # --stage applies secrets atomically with the deploy below (no double restart)
        run: |
          flyctl secrets set \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            NEWSAPI_KEY="${{ secrets.NEWSAPI_KEY }}" \
            OPENWEATHERMAP_API_KEY="${{ secrets.OPENWEATHERMAP_API_KEY }}" \
            EXCHANGE_RATE_API_KEY="${{ secrets.EXCHANGE_RATE_API_KEY }}" \
            PEXELS_API_KEY="${{ secrets.PEXELS_API_KEY }}" \
            --app ${{ env.FLY_APP }} \
            --stage

      - name: Deploy
        # GHCR_TOKEN is a GitHub PAT (read:packages scope) so Fly.io can pull
        # the image from the private ghcr.io registry.
        run: |
          flyctl deploy \
            --app ${{ env.FLY_APP }} \
            --image ${{ env.IMAGE }}:${{ github.sha }} \
            --registry-auth-config "{\"username\":\"${{ github.actor }}\",\"password\":\"${{ secrets.GHCR_TOKEN }}\"}" \
            --wait-timeout 180 \
            --strategy rolling
