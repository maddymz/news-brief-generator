stages:
  - build
  - deploy

variables:
  IMAGE:        $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest
  FLY_APP:      news-brief-generator

# ── Stage 1: Build and push Docker image ─────────────────────────────────────

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    # HTPASSWD_CONTENT is a GitLab "File" type CI variable.
    # GitLab writes the file contents to a temp path; the variable holds that path.
    - cp "$HTPASSWD_CONTENT" nginx/.htpasswd
  script:
    - docker build --tag "$IMAGE" --tag "$IMAGE_LATEST" .
    - docker push "$IMAGE"
    - docker push "$IMAGE_LATEST"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ── Stage 2: Deploy to Fly.io ─────────────────────────────────────────────────

deploy:
  stage: deploy
  image: flyio/flyctl:latest
  before_script:
    - flyctl auth token "$FLY_API_TOKEN" 2>/dev/null || true
    # Stage all secrets so they apply atomically with the new image (no double restart)
    - |
      flyctl secrets set \
        OPENAI_API_KEY="$OPENAI_API_KEY" \
        NEWSAPI_KEY="$NEWSAPI_KEY" \
        OPENWEATHERMAP_API_KEY="$OPENWEATHERMAP_API_KEY" \
        EXCHANGE_RATE_API_KEY="$EXCHANGE_RATE_API_KEY" \
        PEXELS_API_KEY="$PEXELS_API_KEY" \
        --app "$FLY_APP" \
        --stage
  script:
    - |
      flyctl deploy \
        --app "$FLY_APP" \
        --image "$IMAGE" \
        --registry-auth-config "{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}" \
        --wait-timeout 180 \
        --strategy rolling
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs:
    - build
